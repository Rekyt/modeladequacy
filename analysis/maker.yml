sources: maker/

packages:
  - ape
  - XML
  - geiger
  - dplyr

targets:
  all:
    depends: data

  data:
    depends:
      - leafN
      - seed_mass
      - sla

  angio:
    depends: [leafN_subsets, seed_mass_subsets, sla_subsets]

  data/wright_2004.xls:
    command: download_wright_2004(target_name)
    cleanup_level: purge
  # There's a bug here where this randomly rebuilds.  I am trying to
  # track it down.
  wright_2004:
    command: process_wright_2004("data/wright_2004.xls")
  kew:
    command: kew_build()
    cleanup_level: never
    check: exists

  data/leda.txt:
    command: download_leda(target_name)
    cleanup_level: purge
  leda:
    command: process_leda("data/leda.txt")

  data/zae/PhylogeneticResources.zip:
    command: download_zae_trees(target_name)
    cleanup_level: purge
    check: exists
  data/zae/Spermatophyta_Genera.csv:
    command: download_zae_genera(target_name)
    cleanup_level: purge

  vascular_plant_phylogeny:
    command: unpack_tree("data/zae/PhylogeneticResources.zip")
  genus_order_lookup:
    command: unpack_genus_order_lookup("data/zae/Spermatophyta_Genera.csv")

  synonyms:
    command: make_synonyms("data/spermatophyta_synonyms_PLANTLIST.csv", vascular_plant_phylogeny)
  corrections:
    command: make_corrections("data/names-tr.txt", vascular_plant_phylogeny)

  species_leafN:
    command: make_species_leafN(wright_2004, synonyms, corrections)
  species_seed_mass:
    command: make_species_seed_mass(kew, synonyms, corrections)
  species_sla:
    command: make_species_sla(wright_2004, leda, synonyms, corrections)

  leafN:
    command: build_data(species_leafN, vascular_plant_phylogeny)
  seed_mass:
    command: build_data(species_seed_mass, vascular_plant_phylogeny)
  sla:
    command: build_data(species_sla, vascular_plant_phylogeny)

  ## These are the partitioned data sets.  There's repetition here
  ## because I'm not yet supporting templating of target types.
  leafN_subsets:
    depends: [leafN_times, leafN_families, leafN_orders]
  leafN_times:
    command: make_data_times(leafN)
  leafN_families:
    command: make_data_families(leafN)
  leafN_orders:
    command: make_data_orders(leafN)

  seed_mass_subsets:
    depends: [seed_mass_times, seed_mass_families, seed_mass_orders]
  seed_mass_times:
    command: make_data_times(seed_mass)
  seed_mass_families:
    command: make_data_families(seed_mass)
  seed_mass_orders:
    command: make_data_orders(seed_mass)

  sla_subsets:
    depends: [sla_times, sla_families, sla_orders]
  sla_times:
    command: make_data_times(sla)
  sla_families:
    command: make_data_families(sla)
  sla_orders:
    command: make_data_orders(sla)
