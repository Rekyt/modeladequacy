sources: maker/

packages:
  - ape
  - XML
  - geiger
  - dplyr
  - arbutus
  - diversitree
  - parallel

targets:
  all:
    depends: fits_ml

  data:
    depends:
      - leafN
      - seed_mass
      - sla

  angio:
    depends: [leafN_subsets, seed_mass_subsets, sla_subsets]

  data/wright_2004.xls:
    command: download_wright_2004(target_name)
    cleanup_level: purge
  # There's a bug here where this randomly rebuilds.  I am trying to
  # track it down.
  wright_2004:
    command: process_wright_2004("data/wright_2004.xls")
  kew:
    command: kew_build()
    cleanup_level: never
    check: exists

  data/leda.txt:
    command: download_leda(target_name)
    cleanup_level: purge
  leda:
    command: process_leda("data/leda.txt")

  data/zae/PhylogeneticResources.zip:
    command: download_zae_trees(target_name)
    cleanup_level: purge
    check: exists
  data/zae/Spermatophyta_Genera.csv:
    command: download_zae_genera(target_name)
    cleanup_level: purge

  vascular_plant_phylogeny:
    command: unpack_tree("data/zae/PhylogeneticResources.zip")
    ## This will prevent the expensive re-hashing of
    ## PhylogeneticResources.zip
    check: code
  genus_order_lookup:
    command: unpack_genus_order_lookup("data/zae/Spermatophyta_Genera.csv")

  synonyms:
    command: make_synonyms("data/spermatophyta_synonyms_PLANTLIST.csv", vascular_plant_phylogeny)
    ## Also avoids expensive hash
    check: code
  corrections:
    command: make_corrections("data/names-tr.txt", vascular_plant_phylogeny)

  species_leafN:
    command: make_species_leafN(wright_2004, synonyms, corrections)
  species_seed_mass:
    command: make_species_seed_mass(kew, synonyms, corrections)
  species_sla:
    command: make_species_sla(wright_2004, leda, synonyms, corrections)

  leafN:
    command: build_data(species_leafN, vascular_plant_phylogeny)
  seed_mass:
    command: build_data(species_seed_mass, vascular_plant_phylogeny)
  sla:
    command: build_data(species_sla, vascular_plant_phylogeny)

  ## These are the partitioned data sets.  There's repetition here
  ## because I'm not yet supporting templating of target types.
  leafN_subsets:
    command: make_data_subsets(leafN)
  seed_mass_subsets:
    command: make_data_subsets(seed_mass)
  sla_subsets:
    command: make_data_subsets(sla)

  fits_ml_leafN:
    command: run_model_ad_ml(leafN_subsets)
  fits_ml_seed_mass:
    command: run_model_ad_ml(seed_mass_subsets)
  fits_ml_sla:
    command: run_model_ad_ml(sla_subsets)
  fits_ml:
    command: combine_fits(fits_ml_leafN, fits_ml_seed_mass, fits_ml_sla)

  fits_bayes_leafN:
    command: run_model_ad_bayes(leafN_subsets)
  fits_bayes_seed_mass:
    command: run_model_ad_bayes(seed_mass_subsets)
  fits_bayes_sla:
    command: run_model_ad_bayes(sla_subsets)
  fits_bayes:
    command: combine_fits(fits_bayes_leafN, fits_bayes_seed_mass, fits_bayes_sla)

  output/figs/aic-support.pdf:
    plot: {width: 9, height: 6}
    command: fig_model_support_aic(fits_ml)
